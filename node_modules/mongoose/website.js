<<<<<<< HEAD
=======
<<<<<<< HEAD
var fs = require('fs');
var jade = require('jade');
var package = require('./package');
var hl = require('./docs/helpers/highlight');
var linktype = require('./docs/helpers/linktype');
var href = require('./docs/helpers/href');
var klass = require('./docs/helpers/klass');

// add custom jade filters
require('./docs/helpers/filters')(jade);

function getVersion() {
=======
>>>>>>> f09d3ae3d6463bb3bc841a1f35ac01942f76623a
'use strict';

const acquit = require('acquit');
const fs = require('fs');
const jade = require('jade');
const pkg = require('./package');
const linktype = require('./docs/helpers/linktype');
const href = require('./docs/helpers/href');
const klass = require('./docs/helpers/klass');
const transform = require('acquit-require');

require('acquit-ignore')();

const markdown = require('marked');
const highlight = require('highlight.js');
markdown.setOptions({
  highlight: function(code) {
    return highlight.highlight('JavaScript', code).value;
  }
});

jade.filters.markdown = markdown;

const tests = [
  ...acquit.parse(fs.readFileSync('./test/webpack.test.js').toString()),
  ...acquit.parse(fs.readFileSync('./test/geojson.test.js').toString()),
  ...acquit.parse(fs.readFileSync('./test/docs/transactions.test.js').toString()),
  ...acquit.parse(fs.readFileSync('./test/schema.alias.test.js').toString()),
  ...acquit.parse(fs.readFileSync('./test/model.middleware.test.js').toString())
];

function getVersion() {
  return require('./package.json').version;
}

function getLatestLegacyVersion(startsWith) {
<<<<<<< HEAD
=======
>>>>>>> 0f49b6b741d7ccdaba3978328fe07a9401b1b6cd
>>>>>>> f09d3ae3d6463bb3bc841a1f35ac01942f76623a
  var hist = fs.readFileSync('./History.md', 'utf8').replace(/\r/g, '\n').split('\n');
  for (var i = 0; i < hist.length; ++i) {
    var line = (hist[i] || '').trim();
    if (!line) {
      continue;
    }
    var match = /^\s*([^\s]+)\s/.exec(line);
<<<<<<< HEAD
    if (match && match[1] && match[1].startsWith(startsWith)) {
=======
<<<<<<< HEAD
    if (match && match[1]) {
=======
    if (match && match[1] && match[1].startsWith(startsWith)) {
>>>>>>> 0f49b6b741d7ccdaba3978328fe07a9401b1b6cd
>>>>>>> f09d3ae3d6463bb3bc841a1f35ac01942f76623a
      return match[1];
    }
  }
  throw new Error('no match found');
}

<<<<<<< HEAD
=======
<<<<<<< HEAD
function getUnstable(ver) {
  ver = ver.replace('-pre');
  var spl = ver.split('.');
  spl = spl.map(function(i) {
    return parseInt(i, 10);
  });
  spl[1]++;
  spl[2] = 'x';
  return spl.join('.');
}

// use last release
package.version = getVersion();
package.unstable = getUnstable(package.version);
=======
>>>>>>> f09d3ae3d6463bb3bc841a1f35ac01942f76623a
// use last release
pkg.version = getVersion();
pkg.latest4x = getLatestLegacyVersion('4.');
pkg.latest38x = getLatestLegacyVersion('3.8');
<<<<<<< HEAD
=======
>>>>>>> 0f49b6b741d7ccdaba3978328fe07a9401b1b6cd
>>>>>>> f09d3ae3d6463bb3bc841a1f35ac01942f76623a

var filemap = require('./docs/source');
var files = Object.keys(filemap);

function jadeify(filename, options, newfile) {
  options = options || {};
<<<<<<< HEAD
=======
<<<<<<< HEAD
  options.package = package;
  options.hl = hl;
  options.linktype = linktype;
  options.href = href;
  options.klass = klass;
  jade.renderFile(filename, options, function(err, str) {
=======
>>>>>>> f09d3ae3d6463bb3bc841a1f35ac01942f76623a
  options.package = pkg;
  options.linktype = linktype;
  options.href = href;
  options.klass = klass;

  let contents = fs.readFileSync(filename).toString();

  if (options.acquit) {
    contents = transform(contents, tests);
  }

  options.filename = filename;

  jade.render(contents, options, function(err, str) {
<<<<<<< HEAD
=======
>>>>>>> 0f49b6b741d7ccdaba3978328fe07a9401b1b6cd
>>>>>>> f09d3ae3d6463bb3bc841a1f35ac01942f76623a
    if (err) {
      console.error(err.stack);
      return;
    }

    newfile = newfile || filename.replace('.jade', '.html');
<<<<<<< HEAD

=======
<<<<<<< HEAD
=======

>>>>>>> 0f49b6b741d7ccdaba3978328fe07a9401b1b6cd
>>>>>>> f09d3ae3d6463bb3bc841a1f35ac01942f76623a
    fs.writeFile(newfile, str, function(err) {
      if (err) {
        console.error('could not write', err.stack);
      } else {
        console.log('%s : rendered ', new Date, newfile);
      }
    });
  });
}

files.forEach(function(file) {
  var filename = __dirname + '/' + file;
  jadeify(filename, filemap[file]);

  if (process.argv[2] === '--watch') {
    fs.watchFile(filename, {interval: 1000}, function(cur, prev) {
      if (cur.mtime > prev.mtime) {
        jadeify(filename, filemap[file]);
      }
    });
  }
});

<<<<<<< HEAD
=======
<<<<<<< HEAD
var acquit = require('./docs/source/acquit');
var acquitFiles = Object.keys(acquit);
acquitFiles.forEach(function(file) {
  var filename = __dirname + '/docs/acquit.jade';
  jadeify(filename, acquit[file], __dirname + '/docs/' + file);
=======
>>>>>>> f09d3ae3d6463bb3bc841a1f35ac01942f76623a
const _acquit = require('./docs/source/acquit');
const acquitFiles = Object.keys(_acquit);
acquitFiles.forEach(function(file) {
  var filename = __dirname + '/docs/acquit.jade';
  jadeify(filename, _acquit[file], __dirname + '/docs/' + file);
<<<<<<< HEAD
=======
>>>>>>> 0f49b6b741d7ccdaba3978328fe07a9401b1b6cd
>>>>>>> f09d3ae3d6463bb3bc841a1f35ac01942f76623a
});
